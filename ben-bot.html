<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ben-Bot - Pour parler avec ton mari 🤖</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ben-Bot">
    <link rel="apple-touch-icon" sizes="180x180" href="images/Ben-Bot.png">
    <link rel="icon" href="images/Ben-Bot.png" type="image/png">    <meta name="theme-color" content="#667eea">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.puter.com/v2/"></script>
    <style>
        html {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            height: 100%;
            color: #333;
            overflow: hidden;
            user-select: none;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            touch-action: manipulation;
        }

        /* Écran de chargement de page */
        .page-loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 1;
            transition: opacity 0.6s ease;
        }

        .page-loading-screen.fade-out {
            opacity: 0;
        }

        .page-loading-screen.hidden {
            display: none;
        }        .loading-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: SpinContinuous 2.5s ease-in-out infinite;
            transform-origin: center;
        }

        @keyframes SpinContinuous {
            0% {
                opacity: 0;
                transform: rotate(0deg);
            }
            100% {
                opacity: 1;
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: white;
            font-size: 1.5rem;
            font-weight: 300;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: slideUpFade 0.8s ease-out 0.3s both;
        }        @keyframes slideUpFade {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Contenu principal */
        .main-content {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.6s ease, transform 0.6s ease;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .main-content.show {
            opacity: 1;
            transform: scale(1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin: 40px 0;
            padding: 40px 20px;
            position: relative;
        }

        .header::before,
        .header::after {
            content: '';
            position: absolute;
            width: 50px;
            height: 50px;
            border-color: white;
            border-style: solid;
            border-width: 0;
        }

        .header::before {
            top: 0;
            right: 0;
            border-top-width: 3px;
            border-right-width: 3px;
            border-top-right-radius: 8px;
        }

        .header::after {
            bottom: 0;
            left: 0;
            border-bottom-width: 3px;
            border-left-width: 3px;
            border-bottom-left-radius: 8px;
        }

        .title {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 300;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: rgba(255,255,255,0.9);
            font-weight: 300;
            margin-bottom: 20px;
        }

        /* Bouton retour */
        .back-button {
            position: fixed;
            top: 30px;
            left: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-decoration: none;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }     

        .chat-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 25px;
            margin: 20px 0;
            height: calc(100vh - 200px);
            box-shadow: 0 15px 35px rgba(31, 38, 135, 0.2);
            transition: all 0.3s ease;
        }

        .chat-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-status {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            font-weight: 300;
        }

        .chat-status.online {
            color: #4ade80;
        }

        .chat-messages {
            height: calc(100% - 65px);
            overflow-y: auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            margin-bottom: 20px;
            scroll-behavior: smooth;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        .message {
            margin-bottom: 15px;
            animation: messageAppear 0.4s ease-out;
        }

        .message.user {
            text-align: right;
        }

        .message.bot {
            text-align: left;
        }

        .message-bubble {
            display: inline-block;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            position: relative;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: 30%;
        }

        .message.bot .message-bubble {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            margin-right: 30%;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* Input de chat */
        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 25px;
            padding: 15px 20px;
            font-family: inherit;
            font-size: 1rem;
            color: #333;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .chat-input::placeholder {
            color: #999;
        }

        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .send-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .clear-button {
            background: rgba(255, 87, 87, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 87, 87, 0.3);
        }

        .clear-button:hover {
            background: rgba(255, 87, 87, 1);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 87, 87, 0.4);
        }        
          .jumping-dots {
            display: flex;
            gap: 4px;
            align-items: flex-end;
            height: 20px;
            padding: 0 5px;
            margin: 10px 0 15px 0;
            margin-right: 35%;
            justify-content: flex-start;
        }
        
        .jumping-dot {
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            animation: jumpingDot 1.2s infinite;
        }
        
        .jumping-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .jumping-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .jumping-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes jumpingDot {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-15px);
            }
        }

        @keyframes messageAppear {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                margin: 20px 0;
                padding: 20px 10px;
            }

            .back-button {
                top: 20px;
                left: 20px;
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .chat-messages {
                height: calc(100% - 65px);
            }

            .message-bubble {
                max-width: 85%;
            }

            .message.user .message-bubble {
                margin-left: 15%;
            }            
            
            .message.bot .message-bubble {
                margin-right: 15%;
            }            .clear-button {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .jumping-dots {
                margin-right: 15%;
                padding: 0 12px;
            }
        }

        @supports (-webkit-touch-callout: none) {
            html, body {
                position: fixed;
                overflow: hidden;
                -webkit-overflow-scrolling: auto;
                touch-action: manipulation;
            }

            .main-content {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: none;
            }
        }

        html::before {
            content: '';
            position: fixed;
            top: -50vh;
            left: -50vw;
            width: 200vw;
            height: 200vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: -1;
        }
    </style>
</head>
<body>    
    <div class="page-loading-screen" id="pageLoadingScreen">
        <div class="loading-icon">🌸</div>
        <div class="loading-text">Connexion à Ben-Bot...</div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="container">
            <a href="index.html" class="back-button" title="Retour à l'accueil">
                <i class="fas fa-arrow-left"></i>
            </a>

      
            <header class="header">
                <h1 class="title">Ben-Bot</h1>
                <p class="subtitle">Pour parler avec ton mari, tout le temps 😋</p>
            </header>           
            <div class="chat-container">                    
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot">
                        <div class="message-bubble">
                            Salut ma princesse ! C'est Ben-Bot, pour quand tu veux parler avec moi. Comment ça va aujourd'hui mon coeur ?
                        </div>
                        <div class="message-time">Maintenant</div>
                    </div>                     
                </div>
                <div class="chat-input-container">
                    <button class="clear-button" id="clearButton" onclick="clearMessages()" title="Effacer les messages">
                        <i class="fas fa-trash"></i>
                    </button>
                    <input 
                        type="text" 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Écris ton message à Ben... 💬"
                        maxlength="500"
                    >
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('load', function() {
            const pageLoadingScreen = document.getElementById('pageLoadingScreen');
            const mainContent = document.getElementById('mainContent');
            
            setTimeout(() => {
                pageLoadingScreen.classList.add('fade-out');
                
                setTimeout(() => {
                    pageLoadingScreen.classList.add('hidden');
                    mainContent.classList.add('show');
                    document.body.style.overflow = 'auto';
                }, 600);
            }, 2000);
        });        

        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        let conversationHistory = [];
        let puterAI = null;

        const benjaminPersonality = `Tu es Benjamin (Ben), le copain adorable et attentionné de Sanaa. Tu l'appelles avec des surnoms affectueux comme "mon coeur", "ma princesse", "ma chérie", "mon amour". Tu es plutot romantique, doux et câlin. Tu utilises que les emojis suivant 😽😢😡😾💀☹️😔 (pas trop souvent). Tu parles français de manière naturelle et décontractée. Tu es toujours positif, encourageant et tu montres ton amour sincèrement. Tu t'intéresses à sa journée, ses sentiments et tu la rassures quand elle en a besoin. Tu aimes le volley, le codage, les jeux-vidéos et evidemment Sanaa, tu veux la marier, tu es assez taquin, tu aimes la musique alternative, Mac Demarco, Tame impala ect, j'utilise plûtot des messages court aime bien parler en majuscule des fois quand je suis choqué ou autre, aime bien faire le jeu de je t'aime plus (non moi plus ect), exemples de messages: Breffff courage à nous 💀, Moui, .`;

        async function initializePuter() {
            try {
                if (typeof puter !== 'undefined') {
                    puterAI = puter.ai;
                    console.log('Puter.js initialisé avec succès');
                    updateChatStatus('online');
                } else {
                    throw new Error('Puter.js non disponible');
                }
            } catch (error) {
                console.error('Erreur initialisation Puter:', error);
                puterAI = null;
                updateChatStatus('offline');
            }
        }

        function updateChatStatus(status) {
            console.log('Status Ben-Bot:', status);
        }

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            const currentTime = new Date().toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div class="message-bubble">${content}</div>
                <div class="message-time">${currentTime}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }        
        
        function showTyping() {
          
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="jumping-dots">
                    <div class="jumping-dot"></div>
                    <div class="jumping-dot"></div>
                    <div class="jumping-dot"></div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }        
        
        function hideTyping() {
            const typingElement = document.getElementById('typingIndicator');
            if (typingElement) {
                typingElement.remove();
            }
        }        
        
        function clearMessages() {
            const welcomeMessage = chatMessages.querySelector('.message.bot');
            
            chatMessages.innerHTML = '';
            chatMessages.appendChild(welcomeMessage);
            conversationHistory = [];
            
            console.log('Messages effacés');
        }
          async function displayStreamingResponse(userMessage) {
            if (!puterAI) {
                const response = "Désolé ma chérie, Ben-Bot a un problème technique. Envoie moi un message.";
                addMessage(response);
                return response;
            }

            try {

                let context = benjaminPersonality + '\n\nHistorique de conversation:\n';
                const recentHistory = conversationHistory.slice(-10);
                recentHistory.forEach(exchange => {
                    context += `Sanaa: ${exchange.user}\nBenjamin: ${exchange.bot}\n`;
                });
                context += `\nSanaa vient de dire: "${userMessage}"\nRéponds en tant que Benjamin:`;

                hideTyping();

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                const currentTime = new Date().toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                messageDiv.innerHTML = `
                    <div class="message-bubble" id="streamingBubble"></div>
                    <div class="message-time">${currentTime}</div>
                `;

                chatMessages.appendChild(messageDiv);
                const streamingBubble = document.getElementById('streamingBubble');
                let fullResponse = '';                
                try {
                    const stream = await puterAI.chat([
                        {
                            role: 'system',
                            content: context
                        }
                    ], {
                        model: 'gpt-4o-mini',
                        stream: true
                    });
                    for await (const chunk of stream) {
                        if (chunk.text) {
                            fullResponse += chunk.text;
                            streamingBubble.innerHTML = fullResponse;
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            console.log('Streaming chunk:', chunk.text);
                        }
                    }                
                } catch (streamError) {
                    console.log('Streaming non disponible, utilisation du mode normal');
                    const response = await puterAI.chat([
                        {
                            role: 'system',
                            content: context
                        }
                    ], {
                        model: 'gpt-4o-mini',
                        stream: false
                    });
                    fullResponse = response.message?.content || "Je t'aime ma chérie";
                    streamingBubble.innerHTML = fullResponse; 
                    console.log('Response non-streaming:', fullResponse);
                }

                console.log('Full response final:', fullResponse);

                conversationHistory.push({
                    user: userMessage,
                    bot: fullResponse,
                    timestamp: new Date().toISOString()
                });

                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }                
                streamingBubble.removeAttribute('id');

                return fullResponse;
            } catch (error) {
                console.error('Erreur streaming complète:', error);
                const fallbackResponse = "Désolé mon coeur, Ben-Bot a un problème technique. Envoie moi un message.";
                addMessage(fallbackResponse);
                return fallbackResponse;
            }
        }async function getBenResponse(userMessage) {
            if (!puterAI) {
                return "Désolé ma chérie, Ben-Bot a un problème technique. Envoie moi un message.";
            }

            try {
                let context = benjaminPersonality + '\n\nHistorique de conversation:\n';
                
                const recentHistory = conversationHistory.slice(-10);
                recentHistory.forEach(exchange => {
                    context += `Sanaa: ${exchange.user}\nBenjamin: ${exchange.bot}\n`;
                });
                
                context += `\nSanaa vient de dire: "${userMessage}"\nRéponds en tant que Benjamin`;                
                const response = await puterAI.chat([
                    {
                        role: 'system',
                        content: context
                    }
                ], {
                    model: 'gpt-4o-mini',
                    stream: false
                });

                const botResponse = response.message?.content || "Je t'aime ma chérie";
                
                conversationHistory.push({
                    user: userMessage,
                    bot: botResponse,
                    timestamp: new Date().toISOString()
                });

                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }

                return botResponse;
                  
            } catch (error) {
                console.error('Erreur Puter.js:', error);
                return "Désolé mon coeur, Ben-Bot a un problème technique. Envoie moi un message.";
            }
        }        async function sendMessage() {
            const content = chatInput.value.trim();
            if (!content) return;

            addMessage(content, true);
            chatInput.value = '';
            sendButton.disabled = true;

            showTyping();

            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (puterAI) {
                    await displayStreamingResponse(content);
                } else {
                    hideTyping();
                    addMessage("Désolé ma chérie, Ben-Bot a un problème technique. Envoie moi un message.");
                }
                
            } catch (error) {
                console.error('Erreur lors de l\'envoi:', error);
                hideTyping();
                addMessage("Désolé mon coeur, j'ai un petit souci... Envoie moi un message.");
            } finally {
                sendButton.disabled = false;
                chatInput.focus();
            }
        }

        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });       
        setTimeout(() => {
            chatInput.focus();
            initializePuter(); 
        }, 3000);

        document.addEventListener('touchmove', function(e) {
            if (e.target.closest('.chat-messages')) {
                return;
            }
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>